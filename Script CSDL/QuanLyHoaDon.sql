/***** Database QuanLyHoaDon *****/
CREATE DATABASE QuanLyHoaDon

USE QuanLyHoaDon

CREATE TABLE KHACHHANG (
	MAKH char(10) PRIMARY KEY,
	HO nvarchar(20) NOT NULL,
	TEN nvarchar(20) NOT NULL,
	NGSINH SMALLDATETIME NOT NULL,
	DUONG nvarchar(40) NOT NULL,
	QUAN nvarchar(40) NOT NULL,
	TPHO nvarchar(40) NOT NULL,
	DTHOAI nvarchar(12)
)

INSERT INTO KHACHHANG(MAKH, HO, TEN, NGSINH, DUONG, QUAN, TPHO, DTHOAI) VALUES ('KH01', 'HA', 'LAM', '01/01/2001', 'Dlieya', 'Quan 5', 'HCM', '0123')
INSERT INTO KHACHHANG(MAKH, HO, TEN, NGSINH, DUONG, QUAN, TPHO, DTHOAI) VALUES ('KH02', 'NGUYEN', 'MAI', '01/01/2001', 'Dliey0', 'Quan 6', 'HCM', '0123')
INSERT INTO KHACHHANG(MAKH, HO, TEN, NGSINH, DUONG, QUAN, TPHO, DTHOAI) VALUES ('KH03', 'BA', 'LAN', '01/01/2001', 'Dlieya', 'Quan 7', 'HCM', '0123')
INSERT INTO KHACHHANG(MAKH, HO, TEN, NGSINH, DUONG, QUAN, TPHO, DTHOAI) VALUES ('KH04', 'HAI', 'MINH', '01/01/2001', 'Dlieya', 'Quan 8', 'HCM', '0123')

SELECT * FROM KHACHHANG

CREATE TABLE HOADON (
	MAHD char(10) PRIMARY KEY,
	MAKH char(10) NOT NULL,
	NGAYLAP SMALLDATETIME NOT NULL,
	TONGTIEN MONEY NULL,

	CONSTRAINT FK_MaKH_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
)

INSERT INTO HOADON(MAHD, MAKH, NGAYLAP) VALUES ('HD01', 'KH01', '01/01/2001')
INSERT INTO HOADON(MAHD, MAKH, NGAYLAP) VALUES ('HD02', 'KH01', '01/03/2001')
INSERT INTO HOADON(MAHD, MAKH, NGAYLAP) VALUES ('HD03', 'KH01', '01/05/2001')
INSERT INTO HOADON(MAHD, MAKH, NGAYLAP) VALUES ('HD04', 'KH01', '01/04/2001')

SELECT *FROM HOADON

DROP TABLE HOADON

CREATE TABLE SANPHAM (
	MASP char(10) PRIMARY KEY,
	TENSP varchar(40) NOT NULL,
	SL int NOT NULL,
	MOTA varchar(100) ,
	GIA int NOT NULL
)

INSERT INTO SANPHAM(MASP, TENSP, SL, MOTA, GIA) VALUES ('SP01', 'RAU', 5 , '', 200)
INSERT INTO SANPHAM(MASP, TENSP, SL, MOTA, GIA) VALUES ('SP02', 'XA LACH', 10 , 'KHONG DU', 200)
INSERT INTO SANPHAM(MASP, TENSP, SL, MOTA, GIA) VALUES ('SP03', 'BAPSU', 30 , '', 300)

SELECT *FROM SANPHAM

CREATE TABLE CT_HOADON (
	MAHD char(10) NOT NULL,
	MASP char(10) NOT NULL,
	SOLUONG INT NOT NULL,
	GIABAN MONEY NOT NULL,
	GIAGIAM MONEY NULL, 
	THANHTIEN MONEY NULL
	CONSTRAINT PK_CTHD PRIMARY KEY (MAHD, MASP),

	CONSTRAINT FK_Mahd_CTHD_HOADON FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_Masp_CTHD_SANPHAM FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
)

INSERT INTO CT_HOADON(MAHD, MASP, SOLUONG, GIABAN, GIAGIAM) VALUES ('HD01', 'SP01', 3, 3000, 200)
INSERT INTO CT_HOADON(MAHD, MASP, SOLUONG, GIABAN, GIAGIAM) VALUES ('HD02', 'SP01', 5, 3000, 200)
INSERT INTO CT_HOADON(MAHD, MASP, SOLUONG, GIABAN, GIAGIAM) VALUES ('HD01', 'SP03', 5, 3000, 200)
INSERT INTO CT_HOADON(MAHD, MASP, SOLUONG, GIABAN, GIAGIAM) VALUES ('HD01', 'SP02', 8, 3000, 200)
INSERT INTO CT_HOADON(MAHD, MASP, SOLUONG, GIABAN, GIAGIAM) VALUES ('HD02', 'SP02', 10, 5000, 200)

DROP TABLE CT_HOADON

SELECT *FROM CT_HOADON


---trigger 1
CREATE TRIGGER trg_CTDH
ON CT_HOADON
AFTER INSERT AS
BEGIN
	UPDATE CT_HOADON
	SET THANHTIEN = (inserted.GIABAN - inserted.GIAGIAM) * inserted.SOLUONG
	FROM inserted, CT_HOADON	
	WHERE inserted.MAHD = CT_HOADON.MAHD and inserted.MASP = CT_HOADON.MASP
END

DROP TRIGGER trg_CTDH

----trigger 2
CREATE TRIGGER trg_CTDH_HD
ON CT_HOADON
AFTER INSERT
AS
BEGIN
	UPDATE HOADON
	SET TONGTIEN = (SELECT SUM(CT_HOADON.THANHTIEN)
					FROM CT_HOADON inner join inserted on CT_HOADON.MAHD = inserted.MAHD)
	FROM HOADON
	JOIN inserted ON HOADON.MAHD = inserted.MAHD
END

DROP TRIGGER trg_CTDH_HD
